---
# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: secret - vaultStaticSecret - rolloutRestartTargets
templates:
  - common.yaml
values:
  - ../_values/controllers_main_default_container.yaml
  - ../_values/vaultstaticsecret_main_default.yaml
tests:
  - it: should populate rolloutRestartTargets from rolloutRestartControllers
    set:
      vaultStaticSecrets:
        main:
          rolloutRestartControllers:
            - main
    documentSelector:
      path: $[?(@.kind == "VaultStaticSecret")].metadata.name
      value: release-name
    asserts:
      - equal:
          path: spec.rolloutRestartTargets[0].kind
          value: Deployment
      - equal:
          path: spec.rolloutRestartTargets[0].name
          value: release-name

  - it: unknown controllers should be skipped
    set:
      vaultStaticSecrets:
        main:
          rolloutRestartControllers:
            - not-a-controller
    documentSelector:
      path: $[?(@.kind == "VaultStaticSecret")].metadata.name
      value: release-name
    asserts:
      - notExists:
          path: spec.rolloutRestartTargets
